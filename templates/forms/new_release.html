{% extends 'layouts/layout.html' %}
{% block title %}Create a new release{% endblock %}
{% block content %}
{% if userinfo.artist_name is none %} 
<h4> You have not created an artist profile yet.</h4> 

{% else %} 
  <div class="form-wrapper">
    <form action="{{ url_for('create_release_submission') }}"method="post" class="form" name="new_release">
      {{ form.hidden_tag() }}

      <div class="w3-container">
        <h3 class="form-heading">Create a new release</h3>
      </div>

      <div class="w3-container">
          <h4>Release Information</h4>

      </div>

      <div class="w3-container">

        <fieldset class ="form-group" id="tracks-information">

        <div class="form-group">
            <label for="release_name">Release name</label>
            {{ form.release_name(class_ = 'form-control', autofocus = true) }}

        </div>

        <div class="form-group">
            <label for="release_cover_art">Cover Art</label>
            {{ form.release_cover_art(class = 'form-control-file') }}

        </div>

        <div class="form-group">
            <label for="release_text">Description of release</label>
            {{ form.release_text(class_ = 'form-control', autofocus = true) }}

        </div>

        <div class="form-group">
            <label for="release_price">Price of release</label>
            {{ form.release_price(class_ = 'form-control', autofocus = true) }}

        </div>
      </fieldset>

      </div>

      <div class="w3-container">
          <h4>Tracks</h4>

      </div>

      <div class="w3-container">
        <fieldset class ="form-group">
          <label for="track-name-1">Track name</label>
          {{ form.tracks(class_ = 'track-field', autofocus = true) }}
        </fieldset>
      </div>

      <div class="w3-container">
        <input type="submit" value="Create release" class="btn btn-primary btn-lg btn-block">
      </div>
    </form>
    <div class="w3-container">
      <input type="submit" value="Back" class="btn btn-primary btn-lg btn-block" onclick="window.location='/releases/create';" />
    </div>
  </div>
{% endif %}
<script type="text/javascript" src="{{ url_for('static', filename='js/libs/jquery-3.5.1.min.js') }}"></script>
<script type="text/javascript">

$('.track-file-fields').change(function() {

  console.log(123);

  var filename = $(this).val()
  console.log(filename);

  var props = $(this).prop('files');
  var file = props[0];
  console.log(file);

  if (file) {
    getSignedRequest(file);
  }

});

function getSignedRequest(file){
  console.log("getSignedRequest triggered");
  var xhr = new XMLHttpRequest();
  xhr.open("GET", "/sign_s3?file_name="+file.name+"&file_type="+file.type);
  xhr.onreadystatechange = function(){
    if(xhr.readyState === 4){
      if(xhr.status === 200){
        var response = JSON.parse(xhr.responseText);
        console.log("response");
        console.log(response);
        console.log(response.data);
        console.log(response.url);
        console.log(file);
        uploadFile(file, response.data, response.url);
      }
      else{
        alert("Could not get signed URL.");
      }
    }
  };
  xhr.send();
}

function uploadFile(file, s3Data, url){
  console.log("uploadFile triggered");
  var xhr = new XMLHttpRequest();
  xhr.open("POST", s3Data.url);
  console.log(s3Data.url);
  console.log(url);
  console.log(file);

  var postData = new FormData();
  for(key in s3Data.fields){
    postData.append(key, s3Data.fields[key]);
  }
  postData.append('file', file);

  console.log(postData);

  xhr.onreadystatechange = function(error, result) {
    if(xhr.readyState === 4){
      if(xhr.status === 200 || xhr.status === 204){
        alert("File uploaded")
      }
      else{
        console.log(error);
        alert("Could not upload file.");
      }
   }
  };
  xhr.send(postData);
}


</script>

{% endblock %}

