{% extends "layouts/layout.html" %}
{% block title %}{% endblock %}
{% block content %}

<div class="page-content-wrap">
  <div class="page-content-container">
     <h1>If you have submitted a transaction, do not refresh your page until the transaction is confirmed.</h1>
  </div>

  <div class="page-content-flex-container">
    <div class="page-content-flex-subcontainer" id="track-dashboard">

      <div class = "w3-content">
        <h4>
          Track: {{ track.track_name }}
        </h4>

        <h4>
          Artist: {{ track.artist_name }}
        </h4>
        <h4>
          Price: {{ track.price }}
        </h4>
        <h4>
          Release: <a href="/releases/{{ track.release_id }}">{{ track.release_name }}</a>
        </h4>
   
        <div>
          <span>Created on: {{ track.created_on }}</span>
        </div>

      </div>
    </div>

    <div class = "page-content-flex-subcontainer" id="release-dashboard">

      <h4>Cover Art</h4>
      <div>
        <div class = "release-cover-art">
          <img src={{ track.release_cover_art }} />
        </div>

      </div>
      <div>
        <h4>
          Purchasers:
          {% for purchaser in track.purchasers %}
          <ol>
            <a href="../users/{{ purchaser.user_id }}">{{ purchaser.username }}</a>
          </ol>
          {% endfor %}
        </h4>
      </div>

  </div>

  <div class = "page-content-flex-subcontainer" id="smart-contract-dashboard">
    <div id = "user-dashboard">

      <span><h3>User Dashboard</h3></span>

      <div id="wallet_display">
        <span>Current wallet: </span>
        <span id ="account-address"></span>
      </div>

      <div id="eth_balance_display">
        <span>Current ETH balance: </span>
        <span id = "account-balance"></span>
      </div>

      <br>
      <button id="enable-ethereum-button">Enable Ethereum</button>
    </div>

    <div id ="payment-token-dashboard">

        <h3>DAI Dashboard</h3>
        <div id="payment-token-balance-display">
          <span>Current DAI balance: </span>
          <span id ="payment-token-balance"></span>
        </div>

        {% if userinfo and userinfo.purchased is none %}

        <form action="" method="post" >

            <div>
              <label for="pay-contract-amount">Pay DAI to token contract: </label>
              <input type="number" size=50 id="pay-contract-amount" name='pay-contract-amount'></input>
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            </div>
            <div>
              <button type="button" id="btn-pay-contract">Pay</button>
            </div>
        </form>

        {% elif userinfo and userinfo.purchased is not none %}

        <form action="/purchase" method="post" hidden>
            <div>

          
            <label for="pay-contract-amount">Pay DAI to token contract: </label>
            <input type="number" size=50 id="pay-contract-amount">
            <br>
            <button type="button" id="btn-pay-contract">Pay</button></input>
            </div>
        </form>
        
        <span>You have already purchased this release.</span>
        {% else %}

        <form action="/purchase" method="post" hidden>
            <div>

          
            <label for="pay-contract-amount">Pay DAI to token contract: </label>
            <input type="number" size=50 id="pay-contract-amount">
            <br>
            <button type="button" id="btn-pay-contract">Pay</button></input>
            </div>
        </form>

        {% endif %}

      </div>

      <div id = "musicakes-dashboard">
        <h3>Musicakes Dashboard</h3>
        <div id = "musicakes-contract-address-display">
          <span>Contract address: {{ track.smart_contract_address }}</span>

          <!-- proxy element to store and query smart contract address for window.appConfig --->
          <meta id="smart_contract_address" data-address="{{ track.smart_contract_address }}">

          <!-- proxy element to store and query track price for window.appConfig --->
          <meta id="price" data-address="{{ track.price }}">

          <!-- proxy element to store and query track id for window.appConfig --->
          <meta id="track-id" data-address="{{ track.id }}">        

          <!-- proxy element to store and query CSRF token for window.appConfig --->
          <meta id="csrf-token" data-address="{{ csrf_token() }}">   

          <span id = "musicakes-address"></span>
        </div>

        <div id = "musicakes-supply-display">
          <span>Total supply of Musicakes: </span>
          <span id = "musicakes-supply"></span>
        </div>

        <div id = "user-token-balance-display">
          <span>Number of Musicakes held in this wallet: </span>
          <span id = "user-musicakes-balance"></span>
        </div>


        <div id = "musicakes-payment-token-display">
          <span>DAI balance in Musicakes contract: </span>
          <span id = "musicakes-payment-token-balance"></span>
        </div>

        <div id="account-unclaimed-dividends-display">
          <span>Dividends unclaimed: </span>
          <span id="account-unclaimed-dividends"></span>
        </div>

        <div id="claim-dividends-section">
          <button type="button" id="btn-claim-dividends">Claim Dividends</button>
        </div>

        <div id="update-dividends-section">
          <button type="button" id="btn-update-dividends">Update Dividends</button>
        </div>

      </div>

      <div id = "musicakes-management-dashboard">

        <div>

          <h3>Transfer your Musicakes</h3>

        </div>

        
        <div>


            Address to transfer Musicakes: 
            <input type="text" size=50 id="transfer-musicakes-address">
        </div>
        <div>
            Number of Musicakes to transfer: 
            <input type="text" size=50 id="transfer-musicakes-amount">
        </div>

        <div>
          
          <button type="button" id="btn-transfer-musicakes">Transfer</button>
        </div>

      </div>
    </div>

  </div>
</div>
<script type="text/javascript" src="{{ url_for('static', filename='js/libs/jquery-3.5.1.min.js') }}"></script>

<script type="text/javascript">
  window.appConfig = {
    smart_contract_address: $('#smart_contract_address').data(),
    price: $('#price').data(),
    track_id: $('#track-id').data(),
    csrf_token: $('#csrf-token').data()
  }
</script>

<script type="text/javascript" src="{{ url_for('static', filename='js/libs/truffle-contract.js') }}"></script>


<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>


<script type="text/javascript" src="{{ url_for('static', filename='js/purchase_track.js') }}"></script>

{% endblock %}